name: CD - Deploy Gold Models to Production

on:
  push:
    # main dalına yapılan her merge işleminde çalışır
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Python and DBT
        run: pip install dbt-fabric
        
      - name: Build and Deploy Gold Models (DBT Build)
        env:
          DBT_FABRIC_HOST: ${{ secrets.FABRIC_SQL_ENDPOINT }}
          DBT_FABRIC_TOKEN: ${{ secrets.FABRIC_TOKEN }}
        run: |
          # Gold modellerini (Fact, Dim, KPI) üretim ortamında yeniden oluşturur
          cd dbt_project
          dbt build --target production 
          echo "✅ DBT Models Deployed Successfully"
          
      - name: Trigger Power BI Semantic Model Refresh (Optional Deploy)
        # Bu, Fabric REST API kullanarak Pipeline Refresh adımını simüle eder
        run: |
          echo "Power BI Semantic Model Refresh REST API ile tetiklendi."
          
      - name: Deployment Complete Summary
        run: |
          echo "✅ Production Deployment Completed for commit ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
